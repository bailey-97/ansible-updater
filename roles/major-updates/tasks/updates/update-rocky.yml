- name: check rocky linux packages available for update
  dnf:
     list: updates
  register: upgradable

- name: check rocky linux for zfs packages
  dnf:
    list: "{{rocky_zfs}}"
  register: rocky_zfs

- name: check rocky linux for ceph services and packages 
  dnf:
    list: "{{rocky_ceph}}"
  register: rocky_ceph

- name: list upgrade available packages for rocky linux
  debug:
    msg: "{{ upgradable }}"

- name: update rocky linux
  dnf:
      name: "*"
      state: latest
      update_cache: true

- name: check if reboot required for rocky
  shell: dnf needs-restarting -r
  failed_when: false
  register: reboot_yes
  changed_when: false

- name: rebooting rocky
  reboot:
    reboot_timeout: 600
  when: reboot_yes.rc != 0

- name: Wait for system to become reachable again
  wait_for_connection:
    delay: 60
    timeout: 300
  # when: reboot_yes.rc != 0

# - name: waiting for clean pgs...
#   # when: rocky_ceph.rc != 0
#   command: "{{ container_exec_cmd_update_osd|default('') }} ceph --cluster {{ cluster }} pg stat --format json"
#   register: ceph_health_post
#   until: >
#     (((ceph_health_post.stdout | from_json).pg_summary.num_pg_by_state | length) > 0)
#     and
#     (((ceph_health_post.stdout | from_json).pg_summary.num_pg_by_state | selectattr('name', 'search', '^active\\+clean') | map(attribute='num') | list | sum) == (ceph_health_post.stdout | from_json).pg_summary.num_pgs)
#   # delegate_to: "{{ groups[mon_group_name][0] }}"
#   changed_when: false
#   retries: 600
#   delay: 2